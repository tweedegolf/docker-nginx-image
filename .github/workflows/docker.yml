name: Docker

on:
  workflow_call:

jobs:
  docker:
    strategy:
      matrix:
        include:
          - nginx_version: mainline
            nginx_package_src: "https://nginx.org/packages/mainline/debian/"
            latest: true
          - nginx_version: stable
            nginx_package_src: "https://nginx.org/packages/debian/"
            latest: false
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: Build container image
        uses: tweedegolf/build-container-image@main
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          push: ${{ github.ref == 'refs/heads/main' }}
          platforms: "linux/amd64,linux/arm64"
          build-args: |
            NGINX_PACKAGE_SRC=${{matrix.nginx_package_src}}
          tags: |
            ghcr.io/tweedegolf/nginx:${{matrix.nginx_version}}
            ${{ matrix.latest && 'ghcr.io/tweedegolf/nginx:latest' || '' }}
